<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Kinerja Sales Harian</title>
    <style>
        /* Gaya CSS (tidak ada perubahan signifikan) */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        .container { max-width: 800px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        h1, h2, h3 { color: #333; text-align: center; }
        .date-display { text-align: center; font-size: 1.1em; font-weight: bold; margin-bottom: 20px; color: #555; }
        /* Style untuk Total Score */
        #score-display { padding: 10px; border-radius: 5px; font-size: 1.5em; font-weight: bold; margin: 15px auto; width: 70%; text-align: center; color: white; transition: background-color 0.5s; }
        .score-red { background-color: #dc3545; } 
        .score-green { background-color: #28a745; } 

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background-color: #4CAF50; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }

        .btn-group { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; transition: background-color 0.3s; text-decoration: none; display: inline-block; }
        .btn-group-open { background-color: #dc3545; } 
        .btn-group-opened { background-color: #007bff; }
        .btn-group.disabled, .btn-group:disabled { background-color: #6c757d !important; cursor: not-allowed; pointer-events: none; }
        
        .btn-paste { padding: 8px 15px; background-color: #ffc107; color: #333; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-left: 10px; }
        .btn-paste:hover { background-color: #e0a800; }
        .posted-link { display: block; margin-top: 5px; font-size: 0.9em; word-break: break-all; color: #0056b3; text-decoration: underline; }
        .posted-link.empty { color: #6c757d; font-style: italic; }
        
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2196F3; }
        input:focus + .slider { box-shadow: 0 0 1px #2196F3; }
        input:checked + .slider:before { transform: translateX(26px); }

        .reset-section { margin-top: 30px; padding: 15px; border: 1px solid #dc3545; border-radius: 5px; background-color: #ffe0e3; text-align: center; }
        .reset-section button { padding: 10px 20px; background-color: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .reset-section button:hover { background-color: #c82333; }
        /* Gaya input yang diperbarui untuk mencakup nama sales */
        input[type="url"], input[type="text"] { width: 90%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; text-align: left; margin-bottom: 10px; }
        #tiktok-row td { text-align: left; }
        #sales-input-container { text-align: center; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>üóìÔ∏è Monitoring Kinerja Sales Harian</h1>
        
        <div id="current-date" class="date-display"></div>
        
        <div id="sales-input-container">
            <h3>Nama Sales</h3>
            <input type="text" id="sales-name-input" data-key="sales_name" placeholder="Masukkan Nama Anda">
        </div>
        
        <div id="score-display"></div>
        
        <p style="text-align: center; font-style: italic; color: #007bff;">
            Data kinerja akan direset otomatis setiap hari pada jam 01:00 pagi.
        </p>

        <hr>

        <h2>‚úÖ Tugas Harian</h2>
        
        <h3>D-Pack Prospect (3 Konsumen)</h3>
        <table>
            <thead>
                <tr>
                    <th>Deskripsi</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Prospect Konsumen 1 (2 Poin)</td>
                    <td><label class="toggle-switch"><input type="checkbox" data-key="dpack-1" data-score-item="dpack"><span class="slider"></span></label></td>
                </tr>
                <tr>
                    <td>Prospect Konsumen 2 (2 Poin)</td>
                    <td><label class="toggle-switch"><input type="checkbox" data-key="dpack-2" data-score-item="dpack"><span class="slider"></span></label></td>
                </tr>
                <tr>
                    <td>Prospect Konsumen 3 (2 Poin)</td>
                    <td><label class="toggle-switch"><input type="checkbox" data-key="dpack-3" data-score-item="dpack"><span class="slider"></span></label></td>
                </tr>
            </tbody>
        </table>

        <h3>Link Share Facebook Groups (Total 34 Grup, Total 85 Poin)</h3>
        <table>
            <thead>
                <tr>
                    <th>Grup Facebook</th>
                    <th>Aksi & Hasil Postingan</th>
                </tr>
            </thead>
            <tbody id="facebook-links">
                </tbody>
        </table>

        <h3>Link Share TikTok</h3>
        <table>
            <thead>
                <tr>
                    <th>Platform</th>
                    <th>Link Postingan Anda (5 Poin)</th>
                </tr>
            </thead>
            <tbody>
                <tr id="tiktok-row">
                    <td>TikTok</td>
                    <td><input type="url" data-key="tiktok-link" data-score-item="tiktok" placeholder="Masukkan link TikTok di sini"></td>
                </tr>
            </tbody>
        </table>

        <hr>
        
        <div style="text-align: center; margin-top: 20px;">
            <button onclick="sendDataToSheet()" style="padding: 15px 30px; background-color: #007bff; color: white; border: none; border-radius: 8px; font-size: 1.2em; cursor: pointer;">
                Kirim Laporan ke Google Sheet
            </button>
        </div>

        <div class="reset-section">
            <h2>‚ö†Ô∏è Reset Semua Data (Hapus Inputan Manual)</h2>
            <p>Klik tombol di bawah untuk menghapus **semua** data inputan. Membutuhkan password.</p>
            <button onclick="resetDataManual()">Hapus Semua Data</button>
        </div>

    </div>

    <script>
        // --- KONSTANTA & KONFIGURASI ---
        const facebookGroups = [
            // Daftar 34 grup Facebook
            "https://www.facebook.com/groups/527574474067445", "https://www.facebook.com/groups/1515571062072333/buy_sell_discussion", "https://www.facebook.com/groups/424561451062924/buy_sell_discussion", "https://www.facebook.com/groups/744234105620854/buy_sell_discussion", "https://www.facebook.com/groups/1060389500826790", "https://www.facebook.com/groups/1729918277275906/buy_sell_discussion", "https://www.facebook.com/groups/1431901727109664/buy_sell_discussion", "https://www.facebook.com/groups/1695737604019910", "https://www.facebook.com/groups/1634984163405391/buy_sell_discussion", "https://www.facebook.com/groups/312606212267575/buy_sell_discussion", "https://www.facebook.com/groups/1415145062121908/buy_sell_discussion", "https://www.facebook.com/groups/2560913867495115", "https://www.facebook.com/groups/1123248414458055/", "https://www.facebook.com/groups/262810247145987/buy_sell_discussion", "https://www.facebook.com/groups/bursa.aneka.barang/buy_sell_discussion", "https://www.facebook.com/groups/FJBMADIUNCARUBAN/buy_sell_discussion", "https://www.facebook.com/groups/fjbhplaptopmadiun/buy_sell_discussion", "https://www.facebook.com/groups/Marketplace.Madiun", "https://www.facebook.com/groups/1591483817835345", "https://www.facebook.com/groups/pasarbebasngawi/buy_sell_discussion", "https://www.facebook.com/groups/216931985170794/buy_sell_discussion", "https://www.facebook.com/groups/1676570569220636", "https://www.facebook.com/groups/1026579334448278", "https://www.facebook.com/groups/124689993612", "https://www.facebook.com/groups/553815878020170/buy_sell_discussion", "https://www.facebook.com/groups/1555364204778064/buy_sell_discussion/", "https://www.facebook.com/groups/eksmadiun/buy_sell_discussion", "https://www.facebook.com/groups/fjb.madiun.new", "https://www.facebook.com/groups/1297900247227735", "https://www.facebook.com/groups/1522563978000287/buy_sell_discussion", "https://www.facebook.com/groups/1123248414458055", "https://www.facebook.com/groups/1494489857431925/buy_sell_discussion", "https://www.facebook.com/groups/655243929383434", "https://www.facebook.com/groups/2278368475734080/"
        ];

        const STORAGE_PREFIX = "sales_monitor_";
        const RESET_PASSWORD = "M@diun23";
        const LAST_RESET_KEY = STORAGE_PREFIX + "last_reset_date"; 
        const SALES_NAME_KEY = STORAGE_PREFIX + "sales_name"; // Key baru
        const RESET_HOUR = 1; 
        const MIN_GREEN_SCORE = 90;
        
        // PASTE URL WEB APP APPS SCRIPT ANDA DI SINI
        const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbwioQzut9D73XX24Xm_mAjeY-cHaKGHHcS4t2EnBcZabCK2vkpKKtvfk58r9_8e7EDDiw/exec'; 

        // --- KONFIGURASI SKOR BARU ---
        const SCORE_CONFIG = {
            D_PACK: 2,
            FACEBOOK_TOTAL: 85,
            TIKTOK: 5
        };
        const MAX_FACEBOOK_ITEMS = facebookGroups.length; 
        const MAX_D_PACK_ITEMS = 3;
        const FACEBOOK_SCORE_PER_ITEM = SCORE_CONFIG.FACEBOOK_TOTAL / MAX_FACEBOOK_ITEMS; 
        
        const MAX_ACTUAL_SCORE = (MAX_D_PACK_ITEMS * SCORE_CONFIG.D_PACK) + SCORE_CONFIG.FACEBOOK_TOTAL + SCORE_CONFIG.TIKTOK; 
        const SCORE_FACTOR = 100 / MAX_ACTUAL_SCORE; 

        const MAX_GROUP_CLICKS = 11;
        const GROUP_CLICKS_COUNT_KEY = STORAGE_PREFIX + "group_click_count";


        // --- FUNGSI TANGGAL & WAKTU ---
        function displayCurrentDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const today = new Date().toLocaleDateString('id-ID', options);
            document.getElementById('current-date').textContent = `Hari Ini: ${today}`;
        }
        
        function getMidnightToday(hour = 0, minute = 0) {
            const now = new Date();
            return new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute, 0);
        }

        function checkAutoReset() {
            const lastReset = localStorage.getItem(LAST_RESET_KEY);
            const now = new Date();
            
            const resetTimeToday = getMidnightToday(RESET_HOUR, 0);
            const resetTimeYesterday = new Date(resetTimeToday);
            resetTimeYesterday.setDate(resetTimeYesterday.getDate() - 1);
            
            let shouldReset = false;

            if (lastReset) {
                const lastResetDate = new Date(lastReset);
                
                if (now >= resetTimeToday) {
                    if (lastResetDate < resetTimeToday) {
                        shouldReset = true;
                    }
                } else {
                    if (lastResetDate < resetTimeYesterday) {
                        shouldReset = true;
                    }
                }
            } else {
                if (now >= resetTimeToday) {
                     shouldReset = true;
                }
            }
            
            if (shouldReset) {
                // KIRIM LAPORAN SEBELUM RESET OTOMATIS (jika user lupa)
                if (confirm("Reset Harian Otomatis akan dijalankan. Apakah Anda ingin mencoba mengirimkan data terakhir Anda ke Google Sheet sebelum data dihapus?")) {
                    sendDataToSheet(true); 
                }
                runReset(true); 
            }
        }
        
        // --- FUNGSI SCORE ---

        function getCalculatedScore() {
            let actualScore = 0;
            let fbLinkCount = 0;
            
            // D-Pack dan TikTok 
            const dpackStatuses = {};
            document.querySelectorAll('[data-score-item]').forEach((element, index) => {
                const type = element.getAttribute('data-score-item');
                const key = element.getAttribute('data-key');
                const storedValue = localStorage.getItem(STORAGE_PREFIX + key);

                if (type === 'dpack') {
                    const isChecked = storedValue === 'true';
                    dpackStatuses[key] = isChecked;
                    if (isChecked) {
                        actualScore += SCORE_CONFIG.D_PACK;
                    }
                } else if (type === 'tiktok' && storedValue && storedValue.trim() !== "") {
                    actualScore += SCORE_CONFIG.TIKTOK;
                }
            });

            // Grup Facebook Link
            facebookGroups.forEach((url, index) => {
                const keyLink = `fb-link-${index}`;
                const storedLink = localStorage.getItem(STORAGE_PREFIX + keyLink);
                if (storedLink && storedLink.trim() !== "") {
                    fbLinkCount++;
                }
            });
            
            actualScore += fbLinkCount * FACEBOOK_SCORE_PER_ITEM; 
            
            let displayedScore = Math.round(actualScore * SCORE_FACTOR);
            if (displayedScore > 100) displayedScore = 100; 

            return {
                displayedScore: displayedScore,
                dpackStatuses: dpackStatuses
            };
        }

        function calculateScore() {
            const result = getCalculatedScore();
            updateScoreDisplay(result.displayedScore);
        }

        function updateScoreDisplay(score) {
            const scoreElement = document.getElementById('score-display');
            scoreElement.textContent = `TOTAL SCORE: ${score} / 100`;

            scoreElement.classList.remove('score-red', 'score-green');
            if (score < MIN_GREEN_SCORE) {
                scoreElement.classList.add('score-red');
            } else {
                scoreElement.classList.add('score-green');
            }
        }

        // --- FUNGSI KIRIM DATA KE SHEET BARU ---

        async function sendDataToSheet(isAuto = false) {
            if (GOOGLE_SHEET_URL === 'PASTE_URL_APPS_SCRIPT_ANDA_DI_SINI') {
                alert("‚ùå ERROR: Harap ganti 'PASTE_URL_APPS_SCRIPT_ANDA_DI_SINI' dengan Web app URL Apps Script Anda terlebih dahulu!");
                return;
            }

            const salesName = localStorage.getItem(SALES_NAME_KEY) || document.getElementById('sales-name-input').value;
            const scoreResult = getCalculatedScore();
            const tiktokLink = localStorage.getItem(STORAGE_PREFIX + 'tiktok-link') || '';

            if (!salesName || salesName.trim() === "") {
                alert("‚ùå Gagal Kirim: Harap masukkan Nama Sales terlebih dahulu.");
                return;
            }

            const payload = {
                salesName: salesName,
                totalScore: scoreResult.displayedScore,
                dpack1: scoreResult.dpackStatuses['dpack-1'],
                dpack2: scoreResult.dpackStatuses['dpack-2'],
                dpack3: scoreResult.dpackStatuses['dpack-3'],
                tiktokLink: tiktokLink,
                // Kita tidak mengirim 34 link FB individu untuk mempermudah Apps Script
            };

            const button = document.querySelector('button[onclick="sendDataToSheet()"]');
            const originalButtonText = button.textContent;
            button.textContent = 'Mengirim...';
            button.disabled = true;

            try {
                const response = await fetch(GOOGLE_SHEET_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Penting untuk Apps Script doPost saat Who has access = Anyone
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                // Karena menggunakan 'no-cors', responsnya mungkin tidak bisa dibaca (opaque), 
                // jadi kita asumsikan sukses jika fetch berhasil tanpa error jaringan.
                alert(`‚úÖ Laporan sukses dikirim ke Google Sheet!\nScore: ${payload.totalScore} / 100\nNama: ${payload.salesName}`);

            } catch (error) {
                alert(`‚ùå Gagal Kirim Laporan. Terjadi error jaringan atau Apps Script belum di-deploy dengan benar.\nDetail Error: ${error.message}`);
                console.error('Error sending data:', error);
            } finally {
                button.textContent = originalButtonText;
                button.disabled = false;
            }
        }

        // --- FUNGSI FACEBOOK ---

        function checkGroupClickStatus() {
            const count = parseInt(localStorage.getItem(GROUP_CLICKS_COUNT_KEY) || '0', 10);
            return count >= MAX_GROUP_CLICKS;
        }

        function populateFacebookTable() {
            const tableBody = document.getElementById('facebook-links');
            tableBody.innerHTML = ''; 
            
            const isLimitReached = checkGroupClickStatus();

            facebookGroups.forEach((url, index) => {
                const row = tableBody.insertRow();
                const keyOpened = `fb-opened-${index}`;
                const keyLink = `fb-link-${index}`;
                
                const cellGroup = row.insertCell(0);
                const groupName = url.split('/').filter(p => p).pop(); 
                cellGroup.textContent = groupName.replace('buy_sell_discussion', 'Diskusi Jual-Beli'); 
                
                const cellActions = row.insertCell(1);
                
                const isOpened = localStorage.getItem(STORAGE_PREFIX + keyOpened) === 'true';
                const openedClass = isOpened ? 'btn-group-opened' : 'btn-group-open';
                
                const disabledClass = isLimitReached ? 'disabled' : '';

                cellActions.innerHTML += `
                    <a href="${url}" target="_blank" class="btn-group ${openedClass} ${disabledClass}" 
                       data-key="${keyOpened}" 
                       data-index="${index}"
                       onclick="markGroupOpened(event)">
                       Buka Grup
                    </a>
                `;

                cellActions.innerHTML += `<button class="btn-paste" onclick="pasteLinkPrompt('${keyLink}')">Paste Link</button>`;
                
                const storedLink = localStorage.getItem(STORAGE_PREFIX + keyLink);
                const displayLink = storedLink ? storedLink : 'Belum ada link.';
                const linkClass = storedLink ? '' : 'empty';
                cellActions.innerHTML += `<a href="${storedLink}" target="_blank" class="posted-link ${linkClass}" id="display-${keyLink}">${displayLink}</a>`;
            });
        }
        
        function markGroupOpened(event) {
            const button = event.currentTarget;
            const key = button.getAttribute('data-key');
            
            if (button.classList.contains('btn-group-opened') || button.classList.contains('disabled')) {
                return; 
            }

            const currentCount = parseInt(localStorage.getItem(GROUP_CLICKS_COUNT_KEY) || '0', 10);
            localStorage.setItem(GROUP_CLICKS_COUNT_KEY, currentCount + 1);

            button.classList.remove('btn-group-open');
            button.classList.add('btn-group-opened');
            localStorage.setItem(STORAGE_PREFIX + key, 'true');

            if (currentCount + 1 >= MAX_GROUP_CLICKS) {
                alert(`Selamat, Anda telah membuka ${MAX_GROUP_CLICKS} grup! Semua tombol "Buka Grup" telah dinonaktifkan.`);
                disableAllGroupButtons();
            }
        }
        
        function disableAllGroupButtons() {
            document.querySelectorAll('.btn-group').forEach(btn => {
                btn.classList.add('disabled');
            });
        }


        function pasteLinkPrompt(keyLink) {
            const currentLink = localStorage.getItem(STORAGE_PREFIX + keyLink) || '';
            const link = prompt("Masukkan link postingan Anda:", currentLink);

            if (link !== null && link.trim() !== "") {
                const fullKey = STORAGE_PREFIX + keyLink;
                const isNewLink = localStorage.getItem(fullKey) === null || localStorage.getItem(fullKey) === "";
                localStorage.setItem(fullKey, link);

                const displayElement = document.getElementById(`display-${keyLink}`);
                displayElement.textContent = link;
                displayElement.href = link;
                displayElement.classList.remove('empty');
                
                if (isNewLink) { calculateScore(); }
                alert("Link berhasil disimpan!");

            } else if (link === "") {
                const fullKey = STORAGE_PREFIX + keyLink;
                const wasLinkPresent = localStorage.getItem(fullKey) !== null && localStorage.getItem(fullKey) !== "";
                localStorage.removeItem(fullKey);

                const displayElement = document.getElementById(`display-${keyLink}`);
                displayElement.textContent = 'Belum ada link.';
                displayElement.removeAttribute('href');
                displayElement.classList.add('empty');

                if (wasLinkPresent) { calculateScore(); }
                alert("Link berhasil dihapus.");
            }
        }


        // --- FUNGSI RESET DATA ---
        
        function runReset(isAuto) {
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith(STORAGE_PREFIX) && key !== LAST_RESET_KEY && key !== SALES_NAME_KEY) { // JANGAN HAPUS NAMA SALES
                    localStorage.removeItem(key);
                }
            });
            
            localStorage.removeItem(GROUP_CLICKS_COUNT_KEY);

            localStorage.setItem(LAST_RESET_KEY, new Date().toISOString());

            location.reload(); 
            
            if (isAuto) {
                // Notifikasi alert sudah ada di checkAutoReset
            } else {
                alert("‚úÖ Reset Manual berhasil dijalankan!");
            }
        }

        function resetDataManual() {
            const password = prompt("Masukkan password untuk mereset semua data:");
            if (password === RESET_PASSWORD) {
                if (confirm("ANDA YAKIN INGIN MERESET? Pastikan Anda sudah mengirim laporan ke Google Sheet!")) {
                    // Coba kirim laporan manual sekali sebelum reset
                    sendDataToSheet();
                    runReset(false); 
                }
            } else if (password !== null) {
                alert("‚ùå Password salah. Data tidak direset.");
            }
        }


        // --- FUNGSI UMUM ---
        function saveInput(event) {
            const element = event.target;
            const key = element.getAttribute('data-key');
            let value;
            if (element.type === 'checkbox') {
                value = element.checked;
            } else {
                value = element.value;
            }
            if (key) {
                localStorage.setItem(STORAGE_PREFIX + key, value);
            }
            if (element.getAttribute('data-score-item') || key === 'sales_name') {
                calculateScore(); 
            }
        }

        function loadData() {
            document.querySelectorAll('[data-key]').forEach(element => {
                const key = element.getAttribute('data-key');
                const storedValue = localStorage.getItem(STORAGE_PREFIX + key);
                if (storedValue !== null) {
                    if (element.type === 'checkbox') {
                        element.checked = storedValue === 'true';
                    } else {
                        element.value = storedValue;
                    }
                }
            });
            calculateScore();
        }


        // --- INISIALISASI ---
        document.addEventListener('DOMContentLoaded', () => {
            checkAutoReset(); 
            displayCurrentDate(); 
            populateFacebookTable(); 
            loadData(); 

            // Tambahkan event listener untuk semua input yang memiliki data-key
            document.querySelectorAll('[data-key]').forEach(element => {
                element.addEventListener('change', saveInput);
                element.addEventListener('input', saveInput); 
            });
        });
    </script>
</body>
</html>
